@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject TorontoOnlineServerStore TorontoOnlineServerStore
@inject IServerEFCoreRepository ServerEFCoreRepository

@if (Server != null)
{
	<tr style="background-color: @GetBackgroundColor()">
		<td>
			@Server.Name
		</td>
		<td>
			@Server.City
		</td>
		<td style="color:@(Server.IsOnline ? "green" : "red")">
			@(Server.IsOnline ? "online" : "offline")
		</td>
		<td>
			@if (Server.IsOnline)
			{
				Random random = new Random();
				int randomNumber = random.Next(0, 500);
				<text>@randomNumber</text>
			}
			else
			{
				<text>N/A</text>
			}
		</td>
		<td>
			@if (Server.IsOnline)
			{
				<button type="button"
						class="btn btn-outline-danger"
						@onclick="@(() => { SetServerStatus(false); })">
					Turn Off
				</button>
			}
			else
			{
				<button type="button"
						class="btn btn-outline-success"
						@onclick="@(() => { SetServerStatus(true); })">
					Turn oN
				</button>
			}
			&nbsp;
			<a href="/server/@Server.ServerId" class="btn btn-link">Edit</a>
		</td>


		<td>
			<EditForm Model="Server"
					  FormName="@($"form-Server-{Server.ServerId}")"
					  OnValidSubmit="@(() => {DeleteServer(Server.ServerId);})">
				<button type="submit" class="btn btn-primary">Delete</button>
			</EditForm>
		</td>

	</tr>
}

@code {

	[Parameter]
	public Server? Server { get; set; }

	[CascadingParameter(Name = "SelectedCity")]
	public string? SelectedCity { get; set; }

	private void DeleteServer(int serverId)
	{
		if (serverId > 0)
		{
			ServerEFCoreRepository.DeleteServer(serverId);
			NavigationManager.NavigateTo("/servers", true);
		}
	}

	private string GetBackgroundColor()
	{
		if (SelectedCity != null)
		{
			switch (this.SelectedCity)
			{
				case "Toronto": return "powderblue";
				case "Montreal": return "lightgray";
				case "Ottawa": return "palegreen";
				case "Calgary": return "pink";
				case "Halifax": return "white";
				default:
					return "white";
			}
		}
		else
		{
			return "";
		}
	}

	private void SetServerStatus(bool status)
	{
		if (this.Server is not null)
		{
			if (this.Server.IsOnline != status)
			{
				int num = 0;
				switch (this.Server.City)
				{
					case "Toronto":
						num = TorontoOnlineServerStore.GetNumberServerOnline();
						if (status)
							TorontoOnlineServerStore.SetNumberServerOnline(num + 1);
						else if (num > 1)
							TorontoOnlineServerStore.SetNumberServerOnline(num - 1);
						break;
					default:
						break;
				}
				this.Server.IsOnline = status;
				ServerEFCoreRepository.UpdateServer(this.Server.ServerId, Server);
			}

		}
	}//private void SetServerStatus(bool status)

}
